---
title: "VBM Evaluation"
author: "Lucy Kim, Simon Jones"
date: "3/19/2018"
output: html_document
---

# Evaluation of the VBM

## Motivation
The NYU Langone Health has been consistently ranked high in terms of quality but also high in terms of costs per case among academic medical centers nationally even after the adjustment for the case mix and wage indices. Thus, the NYULMH implemented value-based management (VBM) program to reduce costs and improve value of healthcare which can be defined as quality achieved per dollar spent. We aim to evaluate the impact of this program in terms of variable direct cost per case and quality, and estimate cost savings to date.

This analysis code marks May 2014 as the first month of the post-intervention period. 

## Data set up
```{r}
rm(list = ls())

library(data.table)
library(stats)
require(forecast)
library(forcats)
library(nlme)
library(readxl)
library(stringr)
library(sqldf)
library(broom)
library(stargazer)
library(lubridate)
library(lme4)
library(Hmisc)
library(plyr)
library(doBy)
library(clusterSEs)
library(censReg)
library(qcc)
library(ggplot2)
library(dplyr)
library(MASS)
library(reshape2)
library(scales)
library(plm)
library(stringr)

# if not building from scratch, use this already modified dataset
load("~/Box Sync/VBM/Data/vbmR/sample-full2017-postMay2014.RData")

# if builidng from scratch, start from here
pat <- read_excel("~/Box Sync/VBM/Data/Patient Level Data with expense grouping deidentified 1052017.xlsx", guess_max=288364)
pat2 <- read_excel("~/Box Sync/VBM/Data/Sep 2016 - Dec 2017 VBM Paper deintentified_Updated 5.14.18.xlsx", guess_max=94160)

# drop existing readmission flags from the Sep 2016-Dec 2017 data
myvars <- names(pat2) %in% c("NYU Vizient Readmit Flag") 
pat2 <- pat2[!myvars]

# readmission indicators in patUse (from "Sep 2016 - Dec 2017 VBM Paper deintentified_Updated 5.14.18.xlsx") underreport readmission rate for Dec 2017, so replace the readmission indicator with data from another file "Sep 2016 - Dec 2017 VBM Paper deintentified_Updated 5.11.18.xlsx"
pat_readmit <- read_excel("~/Box Sync/VBM/Data/Sep 2016 - Dec 2017 VBM Paper deintentified_Updated 5.11.18.xlsx", guess_max=94160)

# restrict to only patient ID and readmission flag
myvars <- c("PATIENT ID", "NYU Vizient Readmit Flag")
test <- pat_readmit[myvars]

pat2_test <- merge(pat2, test, all.x = TRUE, by="PATIENT ID") 
pat2 <- pat2_test 

NROW(pat)
pat$AdmitDateD   <- as.Date( pat$`Admit Date` )
pat$DischargeDateD   <- as.Date( pat$`Discharge Date` )

min(pat$DischargeDateD ) # "2010-09-01"
max(pat$DischargeDateD ) #  "2017-05-31"

NROW(pat2)
pat2$AdmitDateD   <- as.Date( pat2$`Admit Date` ) 
pat2$DischargeDateD   <- as.Date( pat2$`Discharge Date` )

min(pat2$DischargeDateD ) #  "2016-09-01"
max(pat2$DischargeDateD ) #  "2017-12-31"

# recode race categories in the new discharge data for FY 2017 using the xwalk 
racexwalk <- read.csv("~/Box Sync/VBM/Data/race_xwalk.csv")
test <- merge(pat2, racexwalk, by.x="Race", by.y="alphabet", all.x = T)
test$Race <- test$race_des
pat2 <- test
rm(test)

#subset the first data to Sep 2011 - Aug 2016 (exclude FY 11 & 2017)
pat3 <- subset(pat, pat$DischargeDateD >= "2011-09-01" & pat$DischargeDateD < "2016-09-01")
min(pat3$DischargeDateD ) # "2011-09-01"
max(pat3$DischargeDateD ) #  "2016-08-31"

# before appending data, remove problematic variables
v <- names(pat3) %in% c("NYU Reporting Department â€“ Most Recent", "NYU Reporting Division â€“ Most Recent")
pat3 <- pat3[!v]
v <- names(pat2) %in% c("NYU Reporting Department â€“ Most Recent", "NYU Reporting Division â€“ Most Recent")
pat2 <- pat2[!v]
pat3$`Admit Service` <- as.numeric(pat3$`Admit Service`)
pat3$`Admit Source` <- as.numeric(pat3$`Admit Source`)
pat3$`Admission Type` <- as.numeric(pat3$`Admission Type`)
pat3$`EPIC Discharge Dept` <- as.numeric(pat3$`EPIC Discharge Dept`)
pat3$`Discharge Service` <- as.numeric(pat3$`Discharge Service`)
pat3$`Discharge Disposition` <- as.numeric(pat3$`Discharge Disposition` )
pat3$`MS-DRG` <- as.numeric(pat3$`MS-DRG`)
pat3$`NY-DRG` <- as.numeric(pat3$`NY-DRG`)

# append the two datasets
patUse <- bind_rows(pat3, pat2, .id="id" )
table(patUse$id)
min(patUse$DischargeDateD ) # "2011-09-01"
max(patUse$DischargeDateD ) #  "2017-12-31"

patUse$DischargeDateMonth <- format(patUse$DischargeDateD  , "%Y%m")  
NROW(patUse)

# check readmission rate across months
patUse$readmit <- ifelse(patUse$`NYU Vizient Readmit Flag`=="Y" & !is.na(patUse$`NYU Vizient Readmit Flag`), 1, 0)
summary(patUse$readmit)
ddply(patUse, .(DischargeDateMonth), summarise, M=mean(readmit))
```

Quick data summary
```{r}
# discharge department
table(patUse$`EPIC Discharge Dept_Desc`)
table(patUse$DischargeDateMonth , is.na(patUse$`EPIC Discharge Dept_Desc`))

# check when Lutheran appears
table(patUse$DischargeDateMonth , str_sub(patUse$`EPIC Discharge Dept_Desc`,1,1) == "L") # starts in 201608
table(patUse$DischargeDateMonth , str_sub(patUse$`EPIC Discharge Dept_Desc`,1,1) == "X") # appears only in 2011/09 - 2015/08

# get mean of every numeric columns by month
test <- ddply(patUse, .(DischargeDateMonth), numcolwise(mean))
# expected LOS = 0 before 2012/09
```


Exclude non-inpatient people
```{r}
sum(is.na(patUse$PatientClass_Desc))
table(patUse$PatientClass_Desc)
patUse <- subset(patUse, PatientClass_Desc=="Inpatient")
NROW(patUse)
```

exclude DRG weight = 0 or MS-DRG = 998 or 999
```{r}
# drop MS-DRG = 999
summary(patUse$`MS DRG Weight (CMI)`)
patUse <- subset(patUse, `MS-DRG`!=999 & `MS-DRG`!=998 & `MS DRG Weight (CMI)`!=0)
summary(patUse$`MS DRG Weight (CMI)`)
NROW(patUse)
```

Exclude Rehab hospital & rehab discharges by using reporting department = Rehab or Psych (these are not typically paid using DRG)

1) exclude missing / unknown DRGs or reporting departments 
```{r}
# exclude MS-DRG type is missing and reporting department is missing
patUse <- patUse[complete.cases(patUse[, c("NYU Reporting Department â€“ Most Recent_Desc", "MS-DRG Type")]),]

# exclude if reporting department is unknown
patUse <- subset(patUse, `NYU Reporting Department â€“ Most Recent_Desc`!="UNK")
```

2) define rehab pats when reporting dept = Rehab or MS-DRG = 945/946 & define psych pats when reporting dept = Psych  
```{r}
# rehab dept can use non-rehab diagnosis
table(patUse$`NYU Reporting Department â€“ Most Recent_Desc`, patUse$`MS-DRG`==945 | patUse$`MS-DRG`==946)

# distribution of medical, surgical, rehab patients by reporting dept
table(patUse$`NYU Reporting Department â€“ Most Recent_Desc`, patUse$`MS-DRG Type`)

# create patient type categories
patUse$pattype <- factor(ifelse( (patUse$`MS-DRG`==945 | patUse$`MS-DRG`==946) & patUse$`NYU Reporting Department â€“ Most Recent_Desc`=="Rehabilitation Medicine", 1, ifelse( patUse$`NYU Reporting Department â€“ Most Recent_Desc`=="Psychiatry", 2, ifelse(patUse$`MS-DRG Type`=="MED", 3, ifelse(patUse$`MS-DRG Type`=="SURG", 4, 5)))), labels=c("Report dept=Rehab & MS DRG=945/946", "Report dept=Psych", "Medical", "Surgical", "Unknown"))
table(patUse$pattype)
```

3) drop rehab & psych patients
```{r}
# exclude MS-DRG Type = rehab & reporting dept = "Rehab medicine"
patUse <- subset(patUse, `NYU Reporting Department â€“ Most Recent_Desc`!="Rehabilitation Medicine" & `MS-DRG Type`!="REHAB")
NROW(patUse)

# exclude psych patients
patUse <- subset(patUse, patUse$`NYU Reporting Department â€“ Most Recent_Desc`!="Psychiatry")
NROW(patUse)
```

Exclude newborns (MS-DRG = 795); these can impact calculations when volume fluctuates for newborns as the mother and newborns are both counted
```{r}
table(patUse$`MS-DRG`)
patUse <- subset(patUse, `MS-DRG`!=795)
NROW(patUse)
```

Exclude Lutheran hospitals because they joined the hospital system later  
```{r}
# exclude Lutheran
patUse <- subset(patUse, str_sub(patUse$`EPIC Discharge Dept_Desc`,1,1) != "L" | is.na(patUse$`EPIC Discharge Dept_Desc`))
NROW(patUse)
```

focus on inpatient cases in Tisch 
```{r}
table(patUse$`Custom Patient Type`)

test <- subset(patUse, DischargeDateMonth>="201401" & DischargeDateMonth<="201404")
table(test$`Custom Patient Type`)
# Tisch had 8592 discharges out of 10142 = 8592/10142 = 85% (exclude TS b/c it has zero cost)

# total inpatient costs
ddply(test, .(`Custom Patient Type`), summarise, totalcost = sum(`Enc - Total Variable Direct Cost`))
#   Custom Patient Type  totalcost
# 1                  HI  21475423
# 2                  TI 87266107
sum(test$`Enc - Total Variable Direct Cost`)
# 108741530
# 87266107/108741530 = 80%

patUse <- subset(patUse, !is.na(`Custom Patient Type`) & `Custom Patient Type` %in% c("TI"))
NROW(patUse)
```

## Adjust costs for inflation
Before anything, Robustness Check: Compare with the stats reported in "VBM Task Force Deck_Aug 2017 (DRAFT).pdf"

add monthly health care inflation data from BLS
```{r}
infl <- read_excel("~/Box Sync/VBM/Data/medical_inflation_03102018.xlsx", range = cell_rows(12:132), col_names=TRUE) # seasonally adjusted

# create month 
infl$day <- rep(1,nrow(infl))
infl$Period <-gsub('M','', infl$Period)
infl$Period <- as.numeric(infl$Period)
infl$date <- paste(infl$Year, infl$Period, infl$day, sep="/")
infl$date <- as.Date(infl$date)
infl$month <- format(infl$date, "%Y%m")
  
colnames(infl)[4] <- "cpi"

infl <- subset(infl, date >= "2011-09-01" & date <= "2017-12-01") # keep 2010/09 - 2017/05

infl <- infl[c("month","cpi")]

infl.ts <- ts(infl$cpi, start=c(2011,9), end=c(2017,12), frequency = 12)
plot(infl.ts, ylab="CPI", ylim=c(0,500))
dev.off()

# merge with discharge-level data
patUse <- merge(patUse, infl, by.x="DischargeDateMonth", by.y="month")
table(patUse$DischargeDateMonth)
```

adjust the costs for inflation using the base period = 2010/09 (first month in data)
```{r}
colnames(patUse)[which(colnames(patUse)=="Enc - Total Variable Direct Cost")] <- "tvdc"
colnames(patUse)[which(colnames(patUse)=="ICU/CCU")] <- "ICU"
colnames(patUse)[which(colnames(patUse)=="Operating Room")] <- "OR"
colnames(patUse)[which(colnames(patUse)=="Medical/Surgical Supplies")] <- "supplies"
colnames(patUse)[which(colnames(patUse)=="Inhalation Therapy")] <- "inhalation"
colnames(patUse)[which(colnames(patUse)=="Physical/Occupational Therapy")] <- "POT"
colnames(patUse)[which(colnames(patUse)=="Post Op/Stepdown")] <- "postop"
colnames(patUse)[which(colnames(patUse)=="Routine Care")] <- "routine"

costs <- c("tvdc", "Pharmacy", "Laboratory", "Radiology",  "MRI", "Implants","Blood", "ICU", "OR", "supplies", "inhalation", "POT", "postop", "routine")

# rebase using 2011/09 CPI
for (col in costs) {
  new.col <- paste(col, '_cpi', sep='')
  patUse[, new.col] <- patUse[, col] * 401.605/patUse$cpi
}
```

check that inflation adjustment was done well
```{r}
monthly_cost <- ddply(patUse, .(DischargeDateMonth), summarise, tvdcm=mean(tvdc, na.rm=TRUE), tvdc_cpim=mean(tvdc_cpi, na.rm=TRUE))

# create monthly time-series data
monthly_cost.ts <- ts(monthly_cost, start = c(2011,9), end=c(2017,5), frequency = 12)

pdf("~/Dropbox/Research/VBM/results/inflation_compare.pdf")
par(mfrow=c(2,1))
ts.plot(infl.ts, ylab="CPI", ylim=c(0,500))
ts.plot(monthly_cost.ts[,2:3],
        gpars=list(xlab="Month", ylab="Avg Total Variable Direct Cost", lty=c(1:2)),
        ylim=c(0,20000))
legend("topright", legend = c("Unadjusted", "CPI-adjusted"), lty = 1:2, cex=.65)
dev.off()
```

## Create patient controls

Age group dummies
```{r}
table(patUse$Age)
sum(is.na(patUse$Age))==0

# quciker way of dping the below
patUse$AgeGroup <- cut(patUse$Age,breaks = c(seq(0,90, 5), 130), include.lowest = T)
```

payor group controls
```{r}
table(patUse$`NYU Finance - Payor Group`)
patUse$ins <- patUse$`NYU Finance - Payor Group`
sum(is.na(patUse$ins))

# Medicare, MA, T-Medicaid, Managed Medicaid, Self-pay, private
patUse$ins <- factor(ifelse(patUse$ins=="Medicare", 1, ifelse(patUse$ins=="Medicare HMO", 2, ifelse(patUse$ins=="Medicaid", 3, ifelse(patUse$ins=="Medicaid HMO", 4, ifelse(patUse$ins=="Self Pay", 5, 6))))), labels = c("Medicare FFS", "Medicare MC", "Medicaid FFS", "Medicaid MC", "Self-pay", "Commercial/Other ins"))
```

Gender
```{r}
table(patUse$Gender)
sum(is.na(patUse$Gender))==0
patUse$female <- factor(ifelse(patUse$Gender=="Female" | patUse$Gender=="F",1,0))
```

Race
```{r}
table(patUse$Race, patUse$id)

sum(is.na(patUse$Race))==0 # false; 42 obs have missing Race

patUse$raceGroup <- factor(ifelse(patUse$Race=="White",1,ifelse(patUse$Race=="African American (Black)",2, ifelse(patUse$Race!="Patient Refused" & patUse$Race!="" & patUse$Race!="Unknown",3,4))), labels = c("White", "Black", "Other race", "Unknown"))
patUse$raceGroup[is.na(patUse$Race)] <- "Unknown"
table(patUse$raceGroup)
```

seasonal FE
```{r}
patUse$month <- month(patUse$DischargeDateD)
patUse$season <- factor(ifelse(patUse$month>=3 & patUse$month<=5, 1, ifelse(patUse$month>=6 & patUse$month<=8, 2, ifelse(patUse$month>=9 & patUse$month<=11, 3, 4))), labels = c("Spring", "Summer", "Fall", "Winter"))
```

dummy for surgical/medical/rehab patient
```{r}
table(patUse$`MS-DRG Type`)
colnames(patUse)[which(colnames(patUse)=="MS-DRG Type")] <- "surgical"
patUse$surgical <- factor(ifelse(patUse$surgical=="SURG", 1, 0))
```

CMI
```{r}
colnames(patUse)[which(colnames(patUse)=="MS DRG Weight (CMI)")] <- "CMI"
```

Site indicator
```{r}
table(str_sub(patUse$`EPIC Discharge Dept_Desc`,1,1))

patUse$site <- str_sub(patUse$`EPIC Discharge Dept_Desc`,1,1)
```

Strategic area
```{r}
colnames(patUse)[which(colnames(patUse)=="Strategic Area")] <- "area"
colnames(patUse)[which(colnames(patUse)=="Strategic Area II")] <- "area2"

patUse$area[patUse$area=="Cardio & Vascular"] <- "Cardio Vascular"
patUse$area[patUse$area2=="Cardio & Vascular"] <- "Cardio Vascular"

patUse$area[patUse$area=="Neonatology"] <- "Children Services"
patUse$area[patUse$area=="Others"] <- "Other (Med)"
```

create time trend, post dummmy, time post intervention trend variables
```{r}
allDates <- sort(unique(patUse$DischargeDateMonth))

lastpremonthidx <- 32 # 36 for Aug 2014
allDates[lastpremonthidx]=="201404"
nmonths <- length(allDates)

# will drop April 2014 - Aug 2014 later as this is a transition period (first VBM mtg on 4/19/2014)

dateLookUp <- data.frame(dayMonth = allDates,
                         t = 1:nmonths,
                         int = c(rep(0, lastpremonthidx), rep(1, nmonths-lastpremonthidx)),
                         tpostInt = c(rep(0, lastpremonthidx), 1:(nmonths-lastpremonthidx)))

patUse <- merge(patUse, dateLookUp, by.x="DischargeDateMonth", by.y="dayMonth")

# check the indexing was well done
test <- ddply(patUse, .(DischargeDateMonth), summarise, t = mean(t, na.rm=TRUE), int = mean(int, na.rm=TRUE), tpostInt = mean(tpostInt, na.rm=TRUE))
View(test)
```

create intensity score for supply & pharmacy
```{r}
intensity <- read_excel("~/Box Sync/VBM/Data/2017 Supply and Pharmacy Intensity Weights.xlsx", range = cell_rows(10:767), col_names=TRUE)

colnames(intensity)[which(colnames(intensity)=="Pharmacy Intensity Weight")] <- "pharma_wgt"
colnames(intensity)[which(colnames(intensity)=="Supply Intensity Weight")] <- "supply_wgt"

intensity <- intensity[c("MS-DRG","pharma_wgt", "supply_wgt")]

patUse <- merge(patUse, intensity, by="MS-DRG", all.x=TRUE)
summary(patUse$pharma_wgt)
summary(patUse$supply_wgt)

# unmatched DRGs?
test <- subset(patUse, is.na(pharma_wgt))
table(test$`MS-DRG`) # 90% unmatched have DRG 795 - normal newborn (16941/19056)
table(test$`MS-DRG_Desc`)
table(test$DischargeDateMonth)
```

## Create outcome vars

### Cost outcomes
- Main outcome: `Enc - Total Variable Direct Cost`
- TVDC for subcategories:
  - Blood
  - ICU/CCU
  - Implants
  - Laboratory
  - MRI
  - Pharmacy
  - Radiology
- Cost variability: measure cost variability later using the coefficient of variation (only at the aggregate level)

create sum of ICU/CCU + Post Op/Stepdown & Implants + Supplies
```{r}
patUse$ICU_postop_cpi <- patUse$ICU_cpi + patUse$postop_cpi
patUse$implants_supplies_cpi <- patUse$Implants_cpi + patUse$supplies_cpi
```

### LOS outcome
- average `Length of Stay`
- observed / expected LOS using `NYU Vizient Expected LOS`  

create observed / expected LOS using `NYU Vizient Expected LOS`  
```{r}
colnames(patUse)[which(colnames(patUse)=="NYU Vizient Expected LOS")] <- "explos"
summary(patUse$explos)
#expected LOS = 0 before 2012/09
ddply(patUse, .(DischargeDateMonth), summarise, M=mean(explos))

patUse$oelos <- patUse$`Length of Stay` / (patUse$explos)
```

create percent of cases with O/E LOS > 1.5 ("12% down to 9%") (later average the indicators for each month)
```{r}
hist(patUse$oelos)
summary(patUse$oelos)
patUse$oelos_gt15 <- ifelse(patUse$oelos > 1.5, 1, 0)
```

### create counterbalancing health outcome vars

create readmission outcome
```{r}
patUse$readmit <- ifelse(patUse$`NYU Vizient Readmit Flag`=="Y" & !is.na(patUse$`NYU Vizient Readmit Flag`), 1, 0)
summary(patUse$readmit) 
#expected LOS = 0 before 2012/09
ddply(patUse, .(DischargeDateMonth), summarise, M=mean(readmit))

```

create mortality outcome
```{r}
patUse$death <- ifelse(patUse$`Discharge Disposition_Desc`=="Expired" | patUse$`Discharge Disposition_Desc`=="EXPIRED", 1, 0)
summary(patUse$death) 

# combine death + hospice
table(patUse$`Discharge Disposition_Desc`)
patUse$death_hospice <- ifelse(patUse$`Discharge Disposition_Desc`=="Expired" | patUse$`Discharge Disposition_Desc`=="EXPIRED"| patUse$`Discharge Disposition_Desc`=="HOSPICE/HOME" | patUse$`Discharge Disposition_Desc`=="HOSPICE/MEDICAL FACILITY", 1, 0)
summary(patUse$death_hospice)
# 1.7% mortality / hospice rate
```


### sample restriction
```{r}
patUse2 <- patUse
```

drop 3 obs with LOS = 0
```{r}
# rename LOS column name
colnames(patUse2)[which(colnames(patUse2)=="Length of Stay")] <- "los"
patUse2 <- patUse2[patUse2$los > 0 ,]
```

drop where surgical indicator, insurance, mortality indicator, discharge date month are missing
```{r}
patUse2 <- patUse2[complete.cases(patUse2[, c("surgical", "ins", "death", "death_hospice","DischargeDateMonth")]),]
```

Quick summary stats to check for abnormal values (e.g. negative cost values)
```{r}
nums <- sapply(patUse2, is.numeric)
summary(patUse2[,nums])
```

count and remove discharges with (-) in outcome/age vars, where they shouldn't
```{r}
outcome <- c(costs, "Age", "los")
summary(patUse2[outcome])

# count minus obs
for(i in 1:length(outcome)){
  x <- sum(patUse2[outcome[i]] < 0)
  cat(outcome[i],' has (-) values in ', x, 'obs \n')
}

# remove minus obs
for(i in 1:length(outcome)){
  index <- which(patUse2[,outcome[i]] >= 0)
  patUse2 <- patUse2[index, ]
}
# 658 obs dropped
```

exclude TVDC < $100; cost values can't be too small
```{r}
summary(patUse2$tvdc)
patUse2 <- patUse2[patUse2$tvdc >100, ]
summary(patUse2$tvdc)
```

exclude outlier costs = top 0.05%
```{r}
quantile(patUse2$tvdc_cpi, 0.9995)
quantile(patUse2$tvdc_cpi, 0.9995) / median(patUse2$tvdc_cpi) # bigger than median by a factor of 41

patUse2$big <- patUse2$tvdc_cpi > quantile(patUse2$tvdc_cpi, 0.9995)
sum(patUse2$big)

patUse2 <- patUse2[patUse2$big==0,]
```

create CMI deciles 
```{r}
patUse2$cmiD <- cut(patUse2$CMI, breaks=c(quantile(patUse2$CMI, probs = seq(0, 1, by = 0.1), na.rm=TRUE)),
  labels=c("0-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100"), include.lowest=TRUE)
table(patUse2$cmiD)
```

merge in elixhauser dummies
```{r}
# export the patient data to get elixhauser variables
colnames(patUse2)[which(colnames(patUse2)=="PATIENT ID")] <- "patid"
colnames(patUse2)[which(colnames(patUse2)=="Enc - Primary ICD10 Diagnosis")] <- "icd10"
colnames(patUse2)[which(colnames(patUse2)=="Enc - Primary ICD9 Diagnosis")] <- "icd9"
colnames(patUse2)[which(colnames(patUse2)=="Discharge Date")] <- "dischargedate"
colnames(patUse2)[which(colnames(patUse2)=="MS-DRG")] <- "DRG"

# export to CSV file to run SAS code
v <- c("patid", "icd10", "icd9", "dischargedate", "DRG")
pat_elix_03162018 <- patUse2[v]
write.csv(pat_elix_03162018, file="~/Box Sync/VBM/Data/pat_elix_03162018.csv", row.names = FALSE)

# run SAS codes to create elixhauser comorbidities: see README.md

elix_sas1 <- read.csv("~/Box Sync/VBM/Data/pat_elix_03162018_pre201510.csv", header=TRUE) 
elix_sas2 <- read.csv("~/Box Sync/VBM/Data/pat_elix_03162018_post201510.csv", header=TRUE) 

# rename variables 
for (i in 2:30) {
  j <- i - 1
  new <- paste0("dx",j)
  colnames(elix_sas1)[i] <- new
  colnames(elix_sas2)[i] <- new
}
elix_sas <- rbind(elix_sas1,elix_sas2)
NROW(elix_sas)

# merge with discharge-level data
NROW(patUse2)
patUse2 <- merge(patUse2, elix_sas, by="patid", all.x=TRUE)
```

### Define DRG-weight adjusted costs
```{r}
costs <- c("tvdc", "Pharmacy", "Laboratory", "Radiology",  "MRI", "ICU_postop", "implants_supplies","Blood", "OR", "inhalation","POT", "routine")

costs_lab <- c("Total variable direct", "Pharmacy", "Laboratory", "Radiology",  "MRI", "ICU/CCU and Post Op/Stepdown", "Implants and Medical/Surgical supplies","Blood", "OR", "Inhalation therapy","Physical/Occupational therapy", "Routine care")

costs_cpi <- paste(costs, "_cpi", sep="")
costs_cpi_cmi <- paste(costs, "_cpi_cmi", sep="")

for (col in costs_cpi) {
  y <- paste0(col, "_cmi")
  patUse2[,y] <- patUse2[,col] / patUse2$CMI
}

costs <- c("Pharmacy")
costs_cpi <- paste(costs, "_cpi", sep="")
costs_cpi_cmi <- paste(costs, "_cpi_cmi", sep="")
for (col in costs_cpi) {
  y <- paste0(col, "_cmi")
  patUse2[,y] <- patUse2[,col] / patUse2$pharma_wgt
}
```

save as project
```{r}
patUse3 <- subset(patUse2, DischargeDateMonth < "201209" | DischargeDateMonth > "201308")

save(pat, pat2, pat3, patUse, patUse2, patUse3, dateLookUp, elix_sas, file="~/Box Sync/VBM/Data/vbmR/sample-full2017-postMay2014.RData")
```

save the discharge level data as CSV file for aggregate analysis
```{r}
v <- c("patid","DischargeDateMonth","tvdc_cpi", "los", "oelos", "oelos_gt15", "readmit", "death","dx1","dx2", "dx3", "dx4", "dx5", "dx6", "dx7", "dx8", "dx9", "dx10", "dx11", "dx12", "dx13", "dx14", "dx15", "dx16", "dx17", "dx18", "dx19", "dx20", "dx21", "dx22", "dx23", "dx24", "dx25", "dx26", "dx27", "dx28", "dx29", "cmiD", "surgical", "female", "AgeGroup", "raceGroup", "ins", "t", "int", "tpostInt", "season", "NYU Reporting Department â€“ Most Recent_Desc")
test <- patUse3[v]
write.csv(test, file="~/Box Sync/VBM/Data/patUse3.csv", row.names = FALSE, col.names=TRUE)
```



## Discharge-level analysis
```{r}
load("~/Box Sync/VBM/Data/vbmR/sample-full2017-postMay2014.RData")
```

### frequency table of the division within medicine and surgery DRG group
```{r}
test <- table(patUse3$`NYU Reporting Department â€“ Most Recent_Desc`, patUse3$surgical)
write.csv(test, "~/Dropbox/Research/VBM/results/cohortfreq.csv", col.names=TRUE)
```


### test for serial correlation in error terms within a group
```{r}
patUse3 <- subset(patUse2, DischargeDateMonth < "201209" | DischargeDateMonth > "201308")

table(patUse3$`NYU Reporting Department â€“ Most Recent_Desc`)

pd <- pdata.frame(patUse3, index = c("NYU Reporting Department â€“ Most Recent_Desc", "DischargeDateMonth"))

pwtest()

form <- formula(tvdc_cpi ~ t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins)
pool <- plm(form, data = patUse3, model="pooling")
pwtest(pool)

pwtest(tvdc_cpi ~ t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins, data = patUse3, effect = "pooling")

 glm(formula = x,
              data = patUse3,
              family=Gamma(link="log"),
              na.action="na.omit",
              start=c(20, rep(0,k-1)))
              
```



### Descriptive stats of outcomes
```{r}
patUse3 <- subset(patUse2, DischargeDateMonth < "201209" | DischargeDateMonth > "201308")

# covariates
covar <- c("female", "AgeGroup", "raceGroup", "CMI","NYU Reporting Department â€“ Most Recent_Desc","ins")
covar_lab <- c("Female", "ageGroup", "Race/ethnicity", "DRG weight", "Service line", "Payer")
summary(patUse3[covar])

ddply(patUse3, .(int), summarize, mean = mean(Age), SD = sd(Age))
t.test(Age ~ int, data = patUse3) # t-test of mean difference

# DRG weight
ddply(patUse3, .(int), summarize, mean = mean(CMI), SD = sd(CMI))
t.test(CMI ~ int, data = patUse3) # t-test of mean difference

# Elixhauser comorbidity counts/patient
dxvar <- paste0("dx",1:29)
patUse3$DXcount <- rowSums(patUse3[dxvar], na.rm = TRUE)
ddply(patUse3, .(int), summarize, mean = mean(DXcount), SD = sd(DXcount))

# t-test difference in means between pre- and post-intervention Elixhauser counts
test <- patUse3 %>%
          # filter(int==0 | int==1) %>%
          dplyr::select(int, DXcount)
t.test(DXcount ~ int, data = test, var.equal = TRUE)

table(patUse3$female, patUse3$int)
table(patUse3$AgeGroup, patUse3$int)
table(patUse3$raceGroup, patUse3$int)
table(patUse3$`NYU Reporting Department â€“ Most Recent_Desc`, patUse3$int)
table(patUse3$ins, patUse3$int)

# test of difference in proportions / means for service lines
test <- ddply(patUse3, .(int), summarise, total = length(female))

tbl <- table(patUse3$`NYU Reporting Department â€“ Most Recent_Desc`, patUse3$int)

prop.test(tbl[5,], test$total) # medicine
prop.test(tbl[6,], test$total) # neuro
prop.test(tbl[17,], test$total) # surgery
prop.test(tbl[8,], test$total) # ob-gyn
prop.test(tbl[14,], test$total) # pediatrics

tbl2 <- as.data.frame(tbl[c(2:4,7,9:13,15:16,18),])
test2 <- ddply(tbl2, .(Var2), summarize, N = sum(Freq))
prop.test(test2$N, test$total)

test <- patUse3[c("female","int")]

test$female <- as.numeric(test$female)-1
test <- ddply(test, .(int), summarise, count = sum(female), total = length(female))
prop.test(test$count, test$total)

summary(patUse3$oel)
test <- patUse3[,c("tvdc_cpi", "los","oelos","oelos_gt15","readmit","death","int","surgical")]
ddply(test, .(int), numcolwise(mean))
#   int tvdc_cpi      los oelos oelos_gt15    readmit       death
# 1   0 9326.520 4.574951   Inf  0.6794152 0.06512109 0.009746013
# 2   1 9513.153 4.537724   Inf  0.1305052 0.08192515 0.009413430
ddply(test, .(int, surgical), numcolwise(mean))


costs <- c("tvdc", "Pharmacy", "Laboratory", "Radiology",  "MRI", "ICU_postop", "implants_supplies","Blood", "OR", "inhalation","POT", "routine")
costs_cpi_cmi <- paste(costs, "_cpi_cmi", sep="")

stargazer(patUse3[costs_cpi_cmi], type = "html",
          title="Descriptive statistics", digits=0,
          out="~/Dropbox/Research/VBM/results/summstats_cost.htm",
          covariate.labels=costs_lab,
          summary.stat = c("n", "mean", "sd", "min", "p25", "median", "p75", "max"))

# Pr(subcategory cost > 0)
summary(patUse3[costs_cpi_cmi])
for (col in costs_cpi_cmi) {
  n <- sum(patUse3[col]==0)
  print(paste0(col, ": ", n, " discharges have 0 costs"))
  x <- paste0(col,"_pos")
  patUse3[,x] <- ifelse(patUse3[,col]==0,0,1)
}

costs <- c("tvdc", "Pharmacy", "Laboratory", "Radiology",  "MRI", "ICU_postop", "implants_supplies","Blood", "OR", "inhalation","POT", "routine")
costs_cpi_cmi_pos <- paste(costs, "_cpi_cmi_pos", sep="")

stargazer(patUse3[costs_cpi_cmi_pos], type = "html",
          title="Descriptive statistics", digits=2,
          out="~/Dropbox/Research/VBM/results/summstats_subcost_pos.htm",
          covariate.labels=costs_lab,
          summary.stat = c("n", "mean"))

# conditional on being positive, summ stats on the sub costs
init <- 0
for (col in costs_cpi_cmi) {
  init <- init + 1
  x <- paste0(col,"_pos")
  patUse4 <- patUse3[patUse3[,x]==1,]
  # print(summary(patUse4[,col]))

  stargazer(patUse4[col], type = "html",
          title="Descriptive statistics", digits=0,
          out=paste0("~/Dropbox/Research/VBM/results/summstats_", col,".htm"),
          covariate.labels=costs_lab[init],
          summary.stat = c("n", "mean", "sd", "min", "p25", "median", "p75", "max"))
}

stargazer(patUse3[c("los", "death")], type = "html",
          title="Descriptive statistics", digits=3,
          out="~/Dropbox/Research/VBM/results/summstats2.htm",
          covariate.labels=c("Length of stay (LOS) (days)", "Indicator for in-hospital death"),
          summary.stat = c("n", "mean", "sd", "min", "p25", "median", "p75", "max"))

table(patUse3$DischargeDateMonth, patUse3$explos==0)

stargazer(patUse3[patUse3$DischargeDateMonth >= "201309" & patUse3$explos > 0, c("oelos", "oelos_gt15")], type = "html",
          title="Descriptive statistics", digits=3,
          out="~/Dropbox/Research/VBM/results/summstats3.htm",
          covariate.labels=c("Observed/expected (O/E) LOS ratio", "Indicator for O/E LOS ratio > 1.5"),
          summary.stat = c("n", "mean", "sd", "min", "p25", "median", "p75", "max"))

test <- patUse3[patUse3$DischargeDateMonth >= "201201", c("readmit")]
stargazer(as.data.frame(test), type = "html",
          title="Descriptive statistics", digits=3,
          out="~/Dropbox/Research/VBM/results/summstats4.htm",
          covariate.labels=c("Indicator for hospital readmission"),
          summary.stat = c("n", "mean", "sd", "min", "p25", "median", "p75", "max"))
```

### stacked bar chart of # discharges by patient type across months
```{r}
# by patient type
test <- ddply(patUse2, .(DischargeDateMonth, pattype), summarise, N=length(pattype))
test$N[test$DischargeDateMonth >= "201209" & test$DischargeDateMonth <= "201308"] <- NA

# bar chart
ggplot(test) +
  theme_bw(base_size=13) +
  geom_bar(mapping=aes(x=DischargeDateMonth, y=N, fill=pattype, group=pattype), stat="identity") +
  labs(x="Month", y="Number of discharges",
       title="Number of Medical and Surgical Patient Discharges by Month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=32), colour="red") +
  # geom_vline(aes(xintercept=36), colour="red") +
  scale_y_continuous(limits = c(0,3500),
                     breaks=seq(0,3500,500)) +
  scale_x_discrete(breaks=c("201109","201201","201205","201209","201301","201305","201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/num_discharges_bymedsurg.png", width=20, height=10, units="cm")
```

### plot the mean cost & CMI trajectory 

All patients
```{r}
costs <- c("tvdc")
costs_lab <- c("Total variable direct")
costs_cpi <- paste(costs, "_cpi", sep="")
costs_cpi_cmi <- paste(costs_cpi, "_cmi", sep="")

# compute growth rate 
ddply(patUse2[patUse2$DischargeDateMonth < "201209" | patUse2$DischargeDateMonth > "201308",], .(int), summarise, m=mean(tvdc_cpi_cmi, na.rm=TRUE))
# mean cost in pre =5262.270
patUse2$gr <- 100*(patUse2$tvdc_cpi_cmi - 5262.270)/5262.270
 
keep <- c(costs, costs_cpi, costs_cpi_cmi, "gr", "DischargeDateMonth", "CMI")
test3 <- ddply(patUse2[keep], .(DischargeDateMonth), numcolwise(mean, na.rm=TRUE))

for (col in c(costs, costs_cpi, costs_cpi_cmi,"gr", "CMI")) {
  test3[test3$DischargeDateMonth >= "201209" & test3$DischargeDateMonth <= "201308", col] <- NA
}

# line graphs: build up and show raw, just inflation adjusted, and CMI & inflation adjusted
library(reshape2)
test <- melt(test3[c("gr","tvdc", "tvdc_cpi", "tvdc_cpi_cmi", "DischargeDateMonth")], id.var="DischargeDateMonth")
test$variable <- factor(test$variable, labels = c("Growth","Raw", "Inflation-adjusted", "Inflation and DRG weight-adjusted"))

# all 3 costs together
ggplot(test[tset$variable!="Growth",], aes(x=DischargeDateMonth, y=value, colour=variable, group=variable)) +
  theme_bw(base_size=13) +
  geom_line() +
  geom_point() +
  labs(x="Month", y="Mean cost per discharge ($)",
       title="Mean Total Variable Direct Cost per Discharge by Month") +
       # caption="Notes. May 2014 - August 2014 is the transition period.") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  # guides(col = guide_legend(ncol = 1)) +
  geom_vline(aes(xintercept=32), colour="red") +
  # geom_vline(aes(xintercept=21), colour="red") +
  # geom_vline(aes(xintercept=25), colour="red") +
  scale_y_continuous(limits = c(0,12500),
                     breaks=seq(0,12500,2000)) +
  scale_x_discrete(breaks=c("201109","201201","201205","201209","201301","201305","201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/tvdc_trajectory_all3.pdf", width=20, height=10, units="cm")

#only the inflation & DRG weight adjusted TVDC
ggplot(test[test$variable=="Inflation and DRG weight-adjusted",], aes(x=DischargeDateMonth, y=value, group=variable)) +
  geom_line() +
  geom_point() +
  theme_bw(base_size=13) +
  labs(x="Month", y="Mean cost per discharge ($)",
       # title="Mean Total Variable Direct Cost per Discharge by Month",
       subtitle="All patients") +
       # caption="Notes. May 2014 - August 2014 is the transition period.") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=32), colour="red") +
  scale_y_continuous(limits = c(0,6100),
                     breaks=seq(0,6100,1000)) +
    scale_x_discrete(breaks=c("201109","201201","201205","201209","201301","201305","201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/tvdc_cpi_cmi_trajectory.pdf", width=20, height=10, units="cm")


# % change in costs 
test2 <- subset(test, variable=="Growth")
test2$int <- ifelse(test2$DischargeDateMonth >= "201405",1,0)
 
ggplot(test2, aes(x=DischargeDateMonth, y=value, group=variable)) +
  geom_line() +
  geom_point() +
  theme_bw(base_size=13) +
  labs(x="Month", y="Percentage change (%)") +
       # title="Mean Total Variable Direct Cost per Discharge by Month",
       # subtitle="All patients") +
       # caption="Notes. May 2014 - August 2014 is the transition period.") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=32), colour="black", linetype='dashed') +
  scale_y_continuous(limits = c(-20,20),
                     breaks=seq(-20,20,10)) +
    scale_x_discrete(breaks=c("201109","201201","201205","201209","201301","201305","201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/tvdc_cpi_cmi_gr_trajectory.tiff", width=20, height=10, units="cm")
```

plot separately by patient type
```{r}
# compute growth rate 
ddply(patUse2[patUse2$DischargeDateMonth < "201209" | patUse2$DischargeDateMonth > "201308",], .(int,surgical), summarise, m=mean(tvdc_cpi_cmi, na.rm=TRUE))
# medical: mean cost in pre =5125.333
# surgical: mean cost in pre =5481.823
patUse2$gr <- ifelse(patUse2$pattype=="Surgical", 100*(patUse2$tvdc_cpi_cmi - 5481.823)/5481.823, 100*(patUse2$tvdc_cpi_cmi - 5125.333)/5125.333)

keep <- c(costs, costs_cpi, costs_cpi_cmi, "gr", "DischargeDateMonth", "CMI", "pattype")
test3 <- ddply(patUse2[keep], .(DischargeDateMonth, pattype), numcolwise(mean, na.rm=TRUE))

for (col in c(costs, costs_cpi, costs_cpi_cmi, "CMI")) {
  test3[test3$DischargeDateMonth >= "201209" & test3$DischargeDateMonth <= "201308", col] <- NA
}

# line graphs: build up and show raw, just inflation adjusted, and CMI & inflation adjusted
library(reshape2)
test3 <- data.table(test3)
test <- melt(test3, id.vars=c("DischargeDateMonth","pattype"), measure.vars=c("gr","tvdc", "tvdc_cpi", "tvdc_cpi_cmi"))
test$variable <- factor(test$variable, labels = c("Growth","Raw", "Inflation-adjusted", "Inflation and DRG weight-adjusted"))

ggplot(test[test$variable=="Inflation and DRG weight-adjusted",], aes(x=DischargeDateMonth, y=value, group=pattype, colour=pattype)) +
  geom_line() +
  geom_point() +
  theme_bw(base_size=13) +
  labs(x="Month", y="Mean cost per discharge ($)",
       title="Mean Total Variable Direct Cost per Discharge by Month",
       subtitle="By Medical and Surgical Patients") +
       # caption="Notes. May 2014 - August 2014 is the transition period.") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=32), colour="red") +
  scale_y_continuous(limits = c(0,6100),
                     breaks=seq(0,6100,1000)) +
    scale_x_discrete(breaks=c("201109","201201","201205","201209","201301","201305","201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/trajectory_tvdc_cpi_cmi_pattype.pdf", width=20, height=10, units="cm")


# % change in costs 
test2 <- subset(test, variable=="Growth")
test2$int <- ifelse(test2$DischargeDateMonth >= "201405",1,0)
test2$value[test2$DischargeDateMonth >= "201209" & test2$DischargeDateMonth <= "201308"] <- NA


ggplot(test2, aes(x=DischargeDateMonth, y=value, group=pattype, linetype=pattype)) +
  geom_line() +
  geom_point() +
  theme_bw(base_size=13) +
  labs(x="Month", y="Percentage change (%)") +
       # title="Mean Total Variable Direct Cost per Discharge by Month",
       # caption="Notes. May 2014 - August 2014 is the transition period.") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=32), colour="black", linetype='dashed') +
  scale_y_continuous(limits = c(-20,20),
                     breaks=seq(-20,20,10)) +
    scale_x_discrete(breaks=c("201109","201201","201205","201209","201301","201305","201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/trajectory_tvdc_cpi_cmi_growth_pattype.tiff", width=20, height=10, units="cm")
```


### Regression analysis

just before running regressions, suppress to NA the discharge dates 9/2012 - 8/2013
```{r}
load("~/Box Sync/VBM/Data/vbmR/sample-full2017-postMay2014.RData")

test <- ddply(patUse3, .(DischargeDateMonth), summarise, int = mean(int), tpostInt = mean(tpostInt), t = mean(t))
```


#### Main outcome: Total variable direct cost

```{r}
comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + cmiD",
          "t + int + tpostInt + season + cmiD  + surgical",
          "t + int + tpostInt + season + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + cmiD  + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins")

costs_cpi <- ("tvdc_cpi")
costs_lab <- ("Inflation-adjusted total variable direct costs (%)")

pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)
for (col in costs_cpi) {
  init <- init + 1
  depv <- c(costs_lab[init])

  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse3, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse3,
              family=Gamma(link="log"),
              na.action="na.omit",
              start=c(20, rep(0,k-1)))
  })
  for (i in 1:n) {
    print(summary(result[[i]]))
  }

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,
            # keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
}
```

medical & surgical patients separately
```{r}
# for rehab, they have all elixhauser comorbidity indicators = 0 except 1 pat

comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + cmiD",
          "t + int + tpostInt + season + cmiD + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + cmiD  + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + cmiD + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins")


# medical patients
patUse4 <- subset(patUse3, surgical=="0")

costs_cpi <- ("tvdc_cpi")
costs_lab <- ("Inflation-adjusted total variable direct costs (%)")

pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)

for (col in costs_cpi) {
  init <- init + 1
  depv <- c(costs_lab[init])

  models <- lapply(paste0( rep(col,n),"~", comb), formula)
  
  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse4, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse4,
              family=Gamma(link="log"),
              na.action="na.omit",
              start=c(20, rep(0,k-1)))
  })
  for (i in 1:n) {
    print(summary(result[[i]]))
  }

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, "medical.htm", sep=""))
}


# surgical patients
patUse4 <- subset(patUse3, surgical=="1")

# some variables have only 1 level
for (i in 1:31) {
  x <- paste0("ynel",i)
  print(x)
  print(summary(patUse4[,x]))
}
# ynel25 have only 0 one level (absent) (See https://stackoverflow.com/questions/18171246/error-in-contrasts-when-defining-a-linear-model-in-r)
summary(patUse4$ynel25)

costs_cpi <- ("tvdc_cpi")
costs_lab <- ("Inflation-adjusted total variable direct costs (%)")

pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)

for (col in costs_cpi) {
  init <- init + 1
  depv <- c(costs_lab[init])

  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse4, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse4,
              family=Gamma(link="log"),
              na.action="na.omit",
              start=c(20, rep(0,k-1)))
  })
  for (i in 1:n) {
    print(summary(result[[i]]))
  }

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, "surgical.htm", sep=""))
}
```

#### subcategory costs
```{r}
costs <- c("Pharmacy", "Laboratory", "Radiology",  "MRI", "ICU_postop", "implants_supplies","Blood", "OR", "inhalation","POT", "routine")

costs_lab <- c("Pharmacy", "Laboratory", "Radiology",  "MRI", "ICU/CCU and Post Op/Stepdown", "Implants and Medical/Surgical supplies","Blood", "OR", "Inhalation therapy","Physical/Occupational therapy", "Routine care")

costs_cpi <- paste(costs, "_cpi", sep="")

# for subcategory costs, bunching at zeros -> use two-part gamma models
summary(patUse3[costs_cpi])
for (col in costs_cpi) {
  n <- sum(patUse3[col]==0)
  print(paste0(col, ": ", n, " discharges have 0 costs"))
  x <- paste0(col,"_pos")
  patUse3[,x] <- ifelse(patUse3[,col]==0,0,1)
}
```

for subcategory costs : "Laboratory", "Radiology",  "MRI", "ICU_postop"
```{r}
con <- file("~/Dropbox/Research/VBM/results/test.log")
sink(con, append=TRUE)
sink(con, append=TRUE, type="message")

comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + cmiD",
          "t + int + tpostInt + season + cmiD  + surgical",
          "t + int + tpostInt + season + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + cmiD  + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins")

# everything except pharma & implants
costs <- c("Laboratory", "Radiology",  "MRI", "ICU_postop","Blood", "OR", "inhalation","POT", "routine")
costs_lab <- c("Laboratory", "Radiology",  "MRI", "ICU/CCU and Post Op/Stepdown","Blood", "OR", "Inhalation therapy","Physical/Occupational therapy", "Routine care")

costs_cpi <- paste(costs, "_cpi", sep="")

pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)

for (col in costs_cpi) {
  init <- init + 1
  depv <- c(costs_lab[init])

  # Logit on Pr(cost > 0)
  y <- paste0(col, "_pos")
  models <- lapply(paste0( rep(y,n),"~", comb), formula)

  logitresult <- lapply(models, FUN = function(x) {
      glm(formula = x,
              data = patUse3,
              family=binomial(link="logit"),
              na.action="na.omit")
  })

  # Gamma on costs using (+) costs data  
  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  patUse4 <- patUse3[patUse3[,col] > 0, ]

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse4, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse4,
              family=Gamma(link="log"),
              na.action="na.omit",
              start=c(20, rep(0,k-1)))
  })

  stargazer(logitresult, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, "_pos.htm", sep=""))
  
  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
            # out=paste("/Users/kunheekim/Dropbox/Research/VBM/results/", col, "2.htm", sep=""))
            # out=paste("/home/hcmg/kunhee/VBM/", col, ".htm", sep=""))

  for (i in 1:n) {
    print(col)
    print(summary(logitresult[[i]]))
    print(summary(result[[i]]))
  }
}
```

subcategory costs: "Blood"
```{r}
comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + cmiD",
          "t + int + tpostInt + season + cmiD  + surgical",
          "t + int + tpostInt + season + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + cmiD  + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins")


# some variables have only 1 level
patUse4 <- subset(patUse3, Blood_cpi > 0)
for (i in 1:31) {
  x <- paste0("ynel",i)
  print(x)
  print(summary(patUse4[,x]))
}
# ynel25 have only 0 one level (absent) (See https://stackoverflow.com/questions/18171246/error-in-contrasts-when-defining-a-linear-model-in-r)
summary(patUse4$dx29)


costs <- c("Blood")
costs_lab <- c("Blood")
costs_cpi <- paste(costs, "_cpi", sep="")

pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)

for (col in costs_cpi) {
  init <- init + 1
  depv <- c(costs_lab[init])

  # Logit on Pr(cost > 0)
  y <- paste0(col, "_pos")
  models <- lapply(paste0( rep(y,n),"~", comb), formula)

  logitresult <- lapply(models, FUN = function(x) {
      glm(formula = x,
              data = patUse3,
              family=binomial(link="logit"),
              na.action="na.omit")
  })

  # Gamma on costs using (+) costs data  
  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  patUse4 <- patUse3[patUse3[,col] > 0, ]

  # patUse4$CMIQ <- cut(patUse4$CMI, breaks=c(quantile(patUse4$CMI, probs = seq(0, 1, by = 0.25), na.rm=TRUE)),
                         # labels=c("0-25","25-50","50-75","75-100"), include.lowest=TRUE)

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse4, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse4,
              family=Gamma(link="log"),
              na.action="na.omit",
              start=c(20, rep(0,k-1)))
  })

  stargazer(logitresult, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, "_pos.htm", sep=""))
            # out=paste("/Users/kunheekim/Dropbox/Research/VBM/results/", col, "2.htm", sep=""))
            # out=paste("/home/hcmg/kunhee/VBM/", col, ".htm", sep=""))

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
            # out=paste("/Users/kunheekim/Dropbox/Research/VBM/results/", col, "2.htm", sep=""))
            # out=paste("/home/hcmg/kunhee/VBM/", col, ".htm", sep=""))

  for (i in 1:n) {
    print(col)
    print(summary(logitresult[[i]]))
    print(summary(result[[i]]))
  }
}
```


pharmacy costs
```{r}
costs <- c("Pharmacy")
costs_lab <- c("Pharmacy")
costs_cpi <- paste(costs, "_cpi", sep="")

patUse3$pharma_wgtD <- cut(patUse3$pharma_wgt, breaks=c(unique(quantile(patUse3$pharma_wgt, probs = seq(0, 1, by = 0.1), na.rm=TRUE))) ,labels=c("0-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-100"), include.lowest=TRUE)
table(patUse3$pharma_wgtD)

patUse4 <- subset(patUse3, !is.na(pharma_wgtD))
summary(patUse4$pharma_wgtD)

# some variables have only 1 level
patUse4 <- subset(patUse3, !is.na(pharma_wgtD) & Pharmacy_cpi > 0)
for (i in 1:29) {
  x <- paste0("dx",i)
  print(x)
  print(summary(patUse4[,x]))
}
# ynel25 have only 0 one level (absent) (See https://stackoverflow.com/questions/18171246/error-in-contrasts-when-defining-a-linear-model-in-r)
summary(patUse4$dx29)

comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + pharma_wgtD",
          "t + int + tpostInt + season + pharma_wgtD  + surgical",
          "t + int + tpostInt + season + pharma_wgtD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + pharma_wgtD  + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29  + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + pharma_wgtD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29  + female + AgeGroup + raceGroup + ins")

pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)
for (col in costs_cpi) {
  init <- init + 1
  depv <- c(costs_lab[init])

  # Logit on Pr(cost > 0)
  y <- paste0(col, "_pos")
  models <- lapply(paste0( rep(y,n),"~", comb), formula)

  logitresult <- lapply(models, FUN = function(x) {
      glm(formula = x,
              data = patUse4,
              family=binomial(link="logit"),
              na.action="na.omit")
  })

  # Gamma on costs using (+) costs data
  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  patUse4 <- patUse4[patUse4[,col] > 0, ]

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse4, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse4,
              family=Gamma(link="log"),
              na.action="na.omit",
              start=c(20, rep(0,k-1))
        )
  })

  stargazer(logitresult, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, "_pos.htm", sep=""))
            # out=paste("/Users/kunheekim/Dropbox/Research/VBM/results/", col, "2.htm", sep=""))
            # out=paste("/home/hcmg/kunhee/VBM/", col, ".htm", sep=""))

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
  for (i in 1:n) {
    print(col)
    print(summary(logitresult[[i]]))
    print(summary(result[[i]]))
  }
}
```

supplies costs
```{r}
costs <- c("implants_supplies")
costs_lab <- c("Implants and Medical/Surgical supplies")
costs_cpi <- paste(costs, "_cpi", sep="")

patUse3$supply_wgtD <- cut(patUse3$supply_wgt, breaks=c(quantile(patUse3$supply_wgt, probs = seq(0, 1, by = 0.1), na.rm=TRUE)),
  labels=c("0-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100"), include.lowest=TRUE)
table(patUse3$supply_wgtD)

comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + supply_wgtD",
          "t + int + tpostInt + season + supply_wgtD + surgical",
          "t + int + tpostInt + season + supply_wgtD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + supply_wgtD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29  + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season + supply_wgtD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29  + female + AgeGroup + raceGroup + ins")

pct_chng <- function(x) 100*(exp(x)-1)

patUse4 <- subset(patUse3, !is.na(supply_wgtD))

init <- 0
n <- length(comb)

for (col in costs_cpi) {
  init <- init + 1
  depv <- c(costs_lab[init])

  # Logit on Pr(cost > 0)
  y <- paste0(col, "_pos")
  models <- lapply(paste0( rep(y,n),"~", comb), formula)

  logitresult <- lapply(models, FUN = function(x) {
      glm(formula = x,
              data = patUse4,
              family=binomial(link="logit"),
              na.action="na.omit")
  })

  # Gamma on costs using (+) costs data
  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  patUse4 <- patUse4[patUse4[,col] > 0, ]

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse4, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
        data = patUse4,
        family=Gamma(link="log"),
        na.action="na.omit",
        start=c(20, rep(0,k-1)))
  })

  stargazer(logitresult, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, "_pos.htm", sep=""))
            
  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
    
   for (i in 1:n) {
    print(col)
    print(summary(logitresult[[i]]))
    print(summary(result[[i]]))
  }
}

```


#### LOS outcomes: LOS, O/E Ratio, dummy for (O/E Ratio > 1.5)

plot the LOS trajectory over time
```{r}
keep <- c("DischargeDateMonth", "los", "oelos", "oelos_gt15")

patUse3 <- patUse2

# suppress to NA if expected LOS = 0
for (col in c("oelos", "oelos_gt15")) {
  patUse3[patUse3$explos==0, col] <- NA
}

test <- ddply(patUse3[keep], .(DischargeDateMonth), numcolwise(mean, na.rm=TRUE))

for (col in keep[2:4]) {
  test[test$DischargeDateMonth >= "201209" & test$DischargeDateMonth <= "201308", col] <- NA
}

# LOS trajectory
ggplot(test, aes(x=DischargeDateMonth, y=los, group=1)) +
  geom_line() +
  geom_point() +
  theme_bw(base_size=13) +
  labs(x="Month", y="Length of stay (days)",
       title="Mean length of stay by month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=32), colour="red") +
  ylim(0,5) + 
  scale_x_discrete(breaks=c("201109","201201","201205","201209","201301","201305","201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/los_trajectory.pdf", width=20, height=10, units="cm")

# O/E ratio trajectory
ggplot(test[test$DischargeDateMonth >= "201309",], aes(x=DischargeDateMonth, y=oelos, group=1)) +
  geom_line() +
  geom_point() +
  theme_bw(base_size=13) +
  labs(x="Month", y="Observed/expected LOS ratio",
       title="Mean observed/expected LOS ratio by month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=9), colour="red") +
  ylim(0,1.5) + 
  scale_x_discrete(breaks=c("201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/oelos_trajectory.pdf", width=20, height=10, units="cm")

# O/E ratio > 1.5 trajectory
ggplot(test[test$DischargeDateMonth >= "201309",], aes(x=DischargeDateMonth, y=oelos_gt15, group=1)) +
  geom_line() +
  geom_point() +
  theme_bw(base_size=13) +
  labs(x="Month", y="Proportion of discharges",
       title="Proportion of discharges having observed/expected LOS ratio > 1.5") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=9), colour="red") +
  ylim(0,0.5) +
  scale_x_discrete(breaks=c("201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/oelos_gt15_trajectory.pdf", width=20, height=10, units="cm")
```

LOS
```{r}
los_y <- c("los")
los_y_lab <- c("Length of stay (days)")

patUse3 <- subset(patUse2, (DischargeDateD < "2012-09-01" | DischargeDateD > "2013-08-31"))

# exclude O/E ratio > 99th pctile
summary(patUse3$los)
quantile(patUse3$los, c(.99))

comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + cmiD",
          "t + int + tpostInt + season + cmiD  + surgical",
          "t + int + tpostInt + season + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + cmiD  + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins")

pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)
for (col in los_y) {
  init <- init + 1
  depv <- c(los_y_lab[init])

  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse3, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse3,
              family=Gamma(link="log"),
              na.action="na.omit",
              start=c(5, rep(0,k-1)))
  })

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
}
```

O/E ratio
```{r}
los_y <- c("oelos")
los_y_lab <- c("Observed/Expected (O/E) LOS ratio")

# are expected LOS = 0 for certain months? yes - expected LOS is always 0 before 2012/09 & in 2017/12
table(patUse2$DischargeDateMonth, patUse2$explos==0)

# should use pre-period 2013/09 - 2014/04 only when outcome = O/E ratio
patUse3 <- subset(patUse2, explos > 0 & DischargeDateMonth >= "201309") # drop obs before 2013/09 & 2017/12
table(patUse3$DischargeDateMonth)

# just recode the linear trend term so that it starts from 1 in 2013/09
summary(patUse3$t[patUse3$DischargeDateMonth == "201309"]) # 25
patUse3$t <- patUse3$t-24
table(patUse3$DischargeDateMonth, patUse3$t)
table(patUse3$DischargeDateMonth, patUse3$int)
table(patUse3$DischargeDateMonth, patUse3$tpostInt)

comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + cmiD",
          "t + int + tpostInt + season + cmiD  + surgical",
          "t + int + tpostInt + season + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + cmiD  + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins")


pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)
for (col in los_y) {
  init <- init + 1
  depv <- c(los_y_lab[init])

  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse3, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse3,
              family=Gamma(link="log"),
              na.action="na.omit")
  })

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
}
```


dummy for O/E LOS ratio
```{r}
los_y <- c("oelos_gt15")
los_y_lab <- c("Indicator for having O/E LOS ratio > 1.5")

comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + cmiD",
          "t + int + tpostInt + season + cmiD  + surgical",
          "t + int + tpostInt + season + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + cmiD  + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins")

pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)
for (col in los_y) {
  init <- init + 1
  depv <- c(los_y_lab[init])

  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse3, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse3,
              family=binomial(link="logit"),
              na.action="na.omit")
  })

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
}
```

#### counterbalancing health outcome vars: readmit, death

plot readmission & mortality trajectory
```{r}
patUse3 <- patUse2

keep <- c("DischargeDateMonth", "readmit", "death")
test <- ddply(patUse3[keep], .(DischargeDateMonth), numcolwise(mean, na.rm=TRUE))

for (col in keep[2:length(keep)]) {
  test[test$DischargeDateMonth >= "201209" & test$DischargeDateMonth <= "201308", col] <- NA
}
test$readmit <- 100*test$readmit
test$death <- 100*test$death

# since readmission is not reported before 2012/01, exclude those months
ggplot(test[test$DischargeDateMonth >= "201201",], aes(x=DischargeDateMonth, y=readmit, group=1)) +
  geom_line() +
  geom_point() +
  theme_bw(base_size=13) +
  labs(x="Month", y="Readmission rate (%)",
       title="Readmission Rate (%) by Month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=28), colour="red") +
  ylim(0,15) +
  scale_x_discrete(breaks=c("201201","201205","201209","201301","201305","201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/readmit_trajectory.pdf", width=20, height=10, units="cm")

# mortality
ggplot(test, aes(x=DischargeDateMonth, y=death, group=1)) +
  geom_line() +
  geom_point() +
  theme_bw(base_size=13) +
  labs(x="Month", y="In-hospital mortality rate (%)",
       title="In-Hospital Mortality Rate (%) by Month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", legend.title=element_blank()) +
  geom_vline(aes(xintercept=32), colour="red") +
  ylim(0,3) + 
  scale_x_discrete(breaks=c("201109","201201","201205","201209","201301","201305","201309","201401","201405","201409","201501","201505","201509","201601","201605","201609","201701","201705","201709"))
ggsave("~/Dropbox/Research/VBM/results/death_trajectory.pdf", width=20, height=10, units="cm")
```

```{r}
health_y <- c("readmit")
health_y_lab <- c("Indicator for readmission")

# are expected LOS = 0 for certain months? yes - expected LOS is always 0 before 2012/09
table(patUse2$DischargeDateMonth, patUse2$readmit==1) # readmission=0 always before 2012/01
table(patUse2$DischargeDateMonth, patUse2$death==1) # readmission=0 always before 2012/01

patUse3 <- patUse2[patUse2$DischargeDateMonth >= "201201" ,]

patUse3 <- subset(patUse3, (DischargeDateD < "2012-09-01" | DischargeDateD > "2013-08-31") & DischargeDateMonth!="201712")

table(patUse3$DischargeDateMonth)

# just recode the linear trend term so that it starts from 1 in 201201
summary(patUse3$t[patUse3$DischargeDateMonth == "201201"]) # 5
patUse3$t <- patUse3$t-5 + 1
table(patUse3$DischargeDateMonth, patUse3$t)

comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + cmiD",
          "t + int + tpostInt + season + cmiD  + surgical",
          "t + int + tpostInt + season + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + cmiD  + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins")

pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)
for (col in health_y) {
  init <- init + 1
  depv <- c(health_y_lab[init])

  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse3, na.action="na.omit"))
    k <- length(lmcoef)

    glm(formula = x,
              data = patUse3,
              family=binomial(link="logit"),
              na.action="na.omit")
  })

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
}
```

death
```{r}
health_y <- c("death")
health_y_lab <- c("Indicator for in-hospital death")

library(ResourceSelection) # to assess the goodness of fit

comb <- c("t + int + tpostInt + season",
          "t + int + tpostInt + season + cmiD",
          "t + int + tpostInt + season + cmiD  + surgical",
          "t + int + tpostInt + season + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29",
          "t + int + tpostInt + season + cmiD  + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup",
          "t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins")

patUse3 <- subset(patUse2, DischargeDateD < "2012-09-01" | DischargeDateD > "2013-08-31" )


pct_chng <- function(x) 100*(exp(x)-1)

init <- 0
n <- length(comb)
for (col in health_y) {
  init <- init + 1
  depv <- c(health_y_lab[init])

  models <- lapply(paste0( rep(col,n),"~", comb), formula)

  result <- lapply(models, FUN = function(x) {
    lmcoef <- coef(lm(formula = x, data=patUse3, na.action="na.omit"))
    k <- length(lmcoef)

    glmmodel <- glm(formula = x,
              data = patUse3,
              family=binomial(link="logit"),
              na.action="na.omit")
    print(summary.glm(glmmodel))
    # print(anova(glmmodel, test="Cp"))
  })

  stargazer(result, type="html", report = "vcp*",
            t.auto=F, p.auto=F,keep.stat=c("n","adj.rsq","ll","aic"),
            apply.coef = pct_chng,
            dep.var.labels = depv,
            covariate.labels = c("Time","Intervention","Time After Intervention"),
            out=paste("~/Dropbox/Research/VBM/results/", col, ".htm", sep=""))
}

#Hosmer and Lemeshow goodness of fit (GOF) test (https://www.theanalysisfactor.com/r-glm-model-fit/)

glmmodel <- glm(formula = death ~ t + int + tpostInt + season  + cmiD + surgical + dx1 + dx2 + dx3 + dx4 + dx5 + dx6 + dx7 + dx8 + dx9 + dx10 + dx11 + dx12 + dx13 + dx14 + dx15 + dx16 + dx17 + dx18 + dx19 + dx20 + dx21 + dx22 + dx23 + dx24 + dx25 + dx26 + dx27 + dx28 + dx29 + female + AgeGroup + raceGroup + ins,
              data = patUse3,
              family=binomial(link="logit"),
              na.action="na.omit")
glmmodel_null <- glm(formula = death ~ 1,
              data = patUse3,
              family=binomial(link="logit"),
              na.action="na.omit")
summary(glmmodel_null)
anova(glmmodel_null, glmmodel, test="Cp")
anova(glmmodel_null, glmmodel, test="Chisq")
with(anova(glmmodel_null,glmmodel),pchisq(Deviance,Df,lower.tail=FALSE)[2]) 

hoslem.test(patUse3$death, fitted(glmmodel))
```

### stop sinking file (i.e. saving console output to log file)
```{r}
sink(file=NULL)
```


# SPC of inflation & CMI adjsuted total costs
```{r}
library(qcc)

patUse2$tvdc_cpi_cmi <- patUse2$tvdc_cpi / patUse2$CMI

patUse3 <- subset(patUse2, (DischargeDateMonth < "201209" | DischargeDateMonth > "201308"))

# normalize the cost by substracting the mean cost and dividing by the SD of the cost during the pre-period (2011/09 - 2012/04) 
monthly_cost <- ddply(patUse3, .(int), summarise, tvdc_cpi_cmim=mean(tvdc_cpi_cmi, na.rm=TRUE), tvdc_cpi_cmisd=sd(tvdc_cpi_cmi, na.rm=TRUE))
# mean cost in pre = 5262.270, SD cost in pre = 5038.084
test <- merge(patUse3, monthly_cost, by="int")

# plot % change for all patients
test$tvdc_cpi_cmi_gr <-  100*(test$tvdc_cpi_cmi - 5262.270)/5262.270

# pdf("~/Dropbox/Research/VBM/results/qcc_tvdc_cpi_cmi_gr.pdf")
my.xmr.x <- qcc(data =  qcc.groups(test$tvdc_cpi_cmi_gr[test$int==0],
                                   test$DischargeDateMonth[test$int==0]),
                 newdata= qcc.groups(test$tvdc_cpi_cmi_gr[test$int==1],
                                     test$DischargeDateMonth[test$int==1]),
                title="All patients",
                type = "xbar",
                ylim=c(-20,20),
                ylab="Percentage change (%)",
                xlab="Month",
                axes.las = 1,
                add.stats = F,
                label.limits = c("","")
                )
dev.off()

ddply(patUse3, .(int, surgical), summarise, tvdc_cpi_cmim=mean(tvdc_cpi_cmi, na.rm=TRUE), tvdc_cpi_cmisd=sd(tvdc_cpi_cmi, na.rm=TRUE))
# medical: mean cost in pre =5125.333
# surgical: mean cost in pre =5481.823

# plot % change for medical patients
test$tvdc_cpi_cmi_gr <- ifelse(test$pattype=="Surgical", 100*(test$tvdc_cpi_cmi - 5481.823)/5481.823, 100*(test$tvdc_cpi_cmi - 5125.333)/5125.333)

# surgical
pdf("~/Dropbox/Research/VBM/results/qcc_tvdc_cpi_cmi_gr_surg.pdf")
my.xmr.x <- qcc(data =  qcc.groups(test$tvdc_cpi_cmi_gr[test$int==0 & test$pattype=="Surgical"],
                                   test$DischargeDateMonth[test$int==0 & test$pattype=="Surgical"]),
                 newdata= qcc.groups(test$tvdc_cpi_cmi_gr[test$int==1 & test$pattype=="Surgical"],
                                     test$DischargeDateMonth[test$int==1 & test$pattype=="Surgical"]),
                title="Surgical patients",
                type = "xbar",
                ylim=c(-20,20),
                ylab="Percentage change (%)",
                xlab="Month",
                axes.las = 1,
                add.stats = F,
                label.limits = c("","")
                )
dev.off()

# medical
pdf("~/Dropbox/Research/VBM/results/qcc_tvdc_cpi_cmi_gr_med.pdf")
my.xmr.x <- qcc(data =  qcc.groups(test$tvdc_cpi_cmi_gr[test$int==0 & test$pattype=="Medical"],
                                   test$DischargeDateMonth[test$int==0 & test$pattype=="Medical"]),
                 newdata= qcc.groups(test$tvdc_cpi_cmi_gr[test$int==1 & test$pattype=="Medical"],
                                     test$DischargeDateMonth[test$int==1 & test$pattype=="Medical"]),
                title="Medical patients",
                type = "xbar",
                ylim=c(-20,20),
                ylab="Percentage change (%)",
                xlab="Month",
                axes.las = 1,
                add.stats = F,
                label.limits = c("","")
                )
dev.off()

# plot normalized
test$tvdc_cpi_cmiN = (test$tvdc_cpi_cmi - 5262.270)/5038.084

pdf("~/Dropbox/Research/VBM/results/qcc_tvdc_cpi_cmiN.pdf")
my.xmr.x <- qcc(data =  qcc.groups(test$tvdc_cpi_cmiN[test$int==0],
                                   test$t[test$int==0]),
                 newdata= qcc.groups(test$tvdc_cpi_cmiN[test$int==1],
                                     test$t[test$int==1]),
                title="Statistical Process Control Model: \nMean Inflation and DRG Weight-Adjusted Total Direct Variable Cost per Discharge \nNormalized by Pre-VBM Mean and Standard Deviation",
                type = "xbar",
                ylim=c(-0.2,0.2),
                ylab="Mean total direct variable cost per discharge",
                xlab="Month index" 
                )
dev.off()

pdf("~/Dropbox/Research/VBM/results/qcc_tvdc_cpi.pdf")
my.xmr.x <- qcc(data =  qcc.groups(patUse3$tvdc_cpi[patUse3$int==0],
                                   patUse3$t[patUse3$int==0]),
                 newdata= qcc.groups(patUse3$tvdc_cpi[patUse3$int==1],
                                     patUse3$t[patUse3$int==1]),
                title="Statistical Process Control model: \nMean inflation-adjusted total direct variable cost per discharge by month",
                type = "xbar",
                ylim=c(0,14000),
                ylab="Total direct variable cost ($)")
lines(rep(21,10), seq(0,15000,length.out=10), col="blue")
dev.off()

pdf("~/Dropbox/Research/VBM/results/qcc_tvdc_cpi_cmi.pdf")
my.xmr.x <- qcc(data =  qcc.groups(patUse3$tvdc_cpi_cmi[patUse3$int==0],
                                   patUse3$t[patUse3$int==0]),
                 newdata= qcc.groups(patUse3$tvdc_cpi_cmi[patUse3$int==1],
                                     patUse3$t[patUse3$int==1]),
                title="Statistical Process Control model: \nMean inflation and DRG weight-adjusted total direct variable cost per discharge",
                type = "xbar",
                ylim=c(0,8000),
                ylab="Total direct variable cost per discharge ($)")
lines(rep(21,10), seq(0,15000,length.out=10), col="blue")
dev.off()
```


# Aggregate analysis at the monthly level
The following analysis is at the aggregate level using monthly data.  

export patient discharge level data to get coefficients on month dummies while controlling for patient vars
```{r}
load("~/Box Sync/VBM/Data/vbmR/sample-full2017-postMay2014.RData")

patUse3 <- subset(patUse2, (DischargeDateMonth < "201209" | DischargeDateMonth > "201308"))
write.csv(patUse3, file="~/Box Sync/VBM/Data/patUse3.csv")

```


## Create the monthly time-series data of risk-adjusted TVDC 

import risk-adjusted total costs, which are month fixed effect coefficientss estimated with patient characteristics controls using the discharge-level data in Stata (VBManalysis.do)

```{r}
# import risk-adjusted total costs, which are month fixed effect coefficientss estimated with patient characteristics controls using the discharge-level data in Stata (VBManalysis.do)
racost <- read.csv("~/Dropbox/Research/VBM/data/ra_tvdc_cpi_monthly_050918.csv")
library(zoo)
racost$tt <- as.yearmon(paste(racost$yr, racost$month, sep = "-"))
racost$DischargeDateMonth <- format(racost$tt, "%Y%m")

colnames(racost)[which(colnames(racost)=="ra_month_all")] <- "tvdc_cpi"
colnames(racost)[which(colnames(racost)=="ra_month_surg0")] <- "tvdc_cpi_surg0"
colnames(racost)[which(colnames(racost)=="ra_month_surg1")] <- "tvdc_cpi_surg1"
racost <- racost[c("tvdc_cpi", "tvdc_cpi_surg1", "tvdc_cpi_surg0", "DischargeDateMonth")]

# add in FY 13
allDates <- as.data.frame(sort(unique(patUse$DischargeDateMonth)))
names(allDates) <- "DischargeDateMonth"

lastpremonthidx <- 32
nmonths <- length(allDates$DischargeDateMonth)

allDates$int <- c(rep(0, lastpremonthidx), rep(1, nmonths-lastpremonthidx))
allDates$t <- 1:nmonths

# aggregate data
racost <- merge(racost, allDates, by="DischargeDateMonth", all.y=TRUE)

# create % change from the pre-intervention mean
ddply(racost, .(int), summarise, Mall = mean(tvdc_cpi, na.rm=TRUE), Msurg0 = mean(tvdc_cpi_surg0, na.rm=TRUE), Msurg1 = mean(tvdc_cpi_surg1, na.rm=TRUE))
#   int     Mall   Msurg0   Msurg1
# 1   0 2809.575 2626.095 34150.72

racost$pch <- 100*(racost$tvdc_cpi - 2809.575)/2809.575
racost$pch_surg0 <- 100*(racost$tvdc_cpi_surg0 - 2626.095)/2626.095
racost$pch_surg1 <- 100*(racost$tvdc_cpi_surg1 - 34150.72)/34150.72

# time-series data
aggData.ts <- ts(racost, start=c(2011,9), end=c(2017,12), frequency = 12)
summary(aggData.ts)

plot(aggData.ts[,c("tvdc_cpi")], ylim=c(0,10000) ) # plot avg total variable direct cost
```


## ITS model using the patient risk adjusted TVDC

Work out AR / MA order of time series
```{r}
costs_cpi <- c("tvdc_cpi","tvdc_cpi_surg1", "tvdc_cpi_surg0")
pch <- c("pch", "pch_surg0", "pch_surg1")

for (col in pch) {
  pdf(paste("~/Dropbox/Research/VBM/results/acf_",col,".pdf", sep=""))
  par(mfrow=c(2,1))
  acf(aggData.ts[,col], na.action = na.pass )
  pacf(aggData.ts[,col], na.action = na.pass )
  dev.off()
}
# PACF order= 1 for all pats; =2 for surg, =4 for med pats
```

Define a function to estimate an ITS model
```{r}
f_mav <- function(x,n=5){stats::filter(x,rep(1/n,n), sides=2)}

f_splitPlot2 <- function ( plotTimeSeries, switchObservation, frequency, firstMonth , lastPreMonth ,
                           firstPostMonth ,  lastMonth ,
                           xlab="Date", ylab="Count", main=NULL, sub=NULL, arOrder,
                           ylim=NULL, r) {
  ## Plot outline with shading
  require(forecast)
  library(nlme)
  base <-  switchObservation # row number for the first post period

  ## Intrupted time series model
  time <- 1:NROW(plotTimeSeries)
  intervention <- c(rep(0,base-1),rep(1,NROW(plotTimeSeries)-base+1))
  timeAfterIntervention  <- c(rep(0,base-1),1:((NROW(plotTimeSeries)-base+1)) )
  its.lm <- gls(plotTimeSeries ~ time + intervention +  timeAfterIntervention,
                correlation=corARMA(p=arOrder), method="ML",
                na.action="na.omit")    
  cf1 <- summary(its.lm)
  cf <- cf1$tTable
  print(cf)

  CI <- confint(its.lm)
  print(CI)

  sub <- paste("Overall trend = ", round(cf[2,1],r) , " (", round(CI[2,1],r), ", ", round(CI[2,2],r), "), p=", round(cf[2,4],r), "\n",
               "Change in level = ", round(cf[3,1],r) , " (", round(CI[3,1],r), ", ", round(CI[3,2],r), "), p=", round(cf[3,4],r), "\n",
               "Change in slope = ",  round(cf[4,1],r) , " (", round(CI[4,1],r), ", ", round(CI[4,2],r), "), p=", round(cf[4,4],r) , sep="")
  ts.plot(plotTimeSeries, xlab=NULL,  ylab=ylab, ylim=ylim, main=main, sub=sub)
  title(xlab=xlab, line=5)

  usr <- par("usr")
  lines(rep(lastPreMonth[1] + lastPreMonth[2]/(frequency) ,10), seq(usr[3],usr[4],length.out=10), col="blue", main=NULL)
  ###  Replot data over hashing
  lines(plotTimeSeries , lty="solid", col="black", main=NULL)

  ### Add moving average
  movingAverage <- ts(f_mav(plotTimeSeries),start=firstMonth,
                      end=lastMonth,
                      frequency=frequency)
  lines(movingAverage, lty=1,col='purple', main=NULL)

  # fitted <- ts( its.lm$fitted, start=firstMonth,
  #               end=lastMonth,
  #               frequency=frequency)
  # fitted <- ts( c(its.lm$fitted[1:24], rep(NA,12), its.lm$fitted[25: length(its.lm$fitted)]), start=firstMonth,
  #               end=lastMonth,
  #               frequency=frequency)

  preT <- (2012-firstMonth[1])*12 + 8-firstMonth[2] + 1

  fitted <- ts( c(its.lm$fitted[1:preT], rep(NA,12), its.lm$fitted[(preT+1): length(its.lm$fitted)]), start=firstMonth,
                end=lastMonth,
                frequency=frequency)

  ## Add pre intervetion trend
  preVal <-   window(fitted, start=firstMonth,end=lastPreMonth)
  lines(preVal, lty= "dotted", col='green', lwd=4, main=NULL)

  ## Add post intervention trend
  postVal <- window(fitted, start=firstPostMonth,end=lastMonth)
  lines(postVal,  lty= "dotted", col='red', lwd=4, main=NULL)

  legend("topright", legend = c("Risk-adjusted", "Moving Average", "Fitted Pre", "Fitted Post"), col=c("black", "purple", "green", "red"), lty=c(1,1,3,3), cex=0.9)

  return(its.lm)
} # splitPlot <- function (



f_splitPlot2_glm <- function ( plotTimeSeries, switchObservation, frequency, firstMonth , lastPreMonth ,
                           firstPostMonth ,  lastMonth ,
                           xlab="Date", ylab="Count", main=NULL, sub=NULL, arOrder,
                           ylim=NULL, r) {
  ## Plot outline with shading
  require(forecast)
  library(nlme)
  base <-  switchObservation # row number for the first post period

  ## Intrupted time series model
  time <- 1:NROW(plotTimeSeries)
  intervention <- c(rep(0,base-1),rep(1,NROW(plotTimeSeries)-base+1))
  timeAfterIntervention  <- c(rep(0,base-1),1:((NROW(plotTimeSeries)-base+1)) )

  lmcoef <- coef(lm(plotTimeSeries ~ time + intervention +  timeAfterIntervention, data=patUse2, na.action="na.omit"))
  m <- length(lmcoef)

  its.lm <- glm(plotTimeSeries ~ time + intervention +  timeAfterIntervention,
              family=Gamma(link="log"),
              na.action="na.omit",
              start=c(20, rep(0,m-1)))

  cf <- summary(its.lm)
  print(cf)

  coef <- cf$coefficients[,1]
  coef <- 100*(exp(coef)-1)
  pv <- cf$coefficients[,4]
  CI <- confint(its.lm)
  print(CI)
  CIconv <- 100*(exp(CI)-1)
  print(CIconv)

  sub <- paste("Overall trend = ", round(coef[2],3), "% (", round(CIconv[2,1],3), ", ", round(CIconv[2,2],3),"), p=", round(pv[2],3), "\n",
               "Change in level = ", round(coef[3],3) , "% (", round(CIconv[3,1],3), ", ", round(CIconv[3,2],3),"), p=", round(pv[3],3), "\n",
               "Change in slope = ",  round(coef[4],3) , "% (", round(CIconv[4,1],3), ", ", round(CIconv[4,2],3),"), p=", round(pv[4],3), sep="")

  ts.plot(plotTimeSeries, xlab=NULL,  ylab=ylab, ylim=ylim, main=main, sub=sub)
  title(xlab=xlab, line=5)

  usr <- par("usr")
  lines(rep(lastPreMonth[1] + lastPreMonth[2]/(frequency) ,10), seq(usr[3],usr[4],length.out=10), col="blue")
  ###  Replot data over hashing
  lines(plotTimeSeries , lty="solid", col="black")

  ### Add moving average
  movingAverage <- ts(f_mav(plotTimeSeries),start=firstMonth,
                      end=lastMonth,
                      frequency=frequency)
  lines(  movingAverage, lty=1,col='purple')

  fitted <- ts( c(its.lm$fitted[1:24], rep(NA,12), its.lm$fitted[25: length(its.lm$fitted)]), start=firstMonth,
                end=lastMonth,
                frequency=frequency)

  ## Add pre intervetion trend
  preVal <-   window(fitted, start=firstMonth,end=lastPreMonth)
  lines(  preVal, lty= "dotted", col='green', lwd=4)

  ## Add post intervention trend
  postVal <- window(fitted, start=firstPostMonth,end=lastMonth)
  lines(  postVal,  lty= "dotted", col='red', lwd=4)

  legend("topright", legend = c("Risk-adjusted", "Moving Average", "Fitted Pre", "Fitted Post"), col=c("black", "purple", "green", "red"), lty=c(1,1,3,3), cex=0.9)

  return(its.lm)
}
```

Run ITS model with marginal effects from the patient-level analysis - using actual cost scale 
```{r}
# PACF order= 3 for all & medical pats; =1 for med pats

y <- c("tvdc_cpi")
y_ul <- c(4000)
y_lab <- c("Patient risk-adjusted total variable direct costs \nAll patients")
round = rep(3, length(y))

init <- 0
for (col in y) {
  init <-  init + 1
  pdf(paste("~/Dropbox/Research/VBM/results/its_",col,".pdf", sep=""))
  rr <- paste0("its_",col)

  print(col)
  rr <- f_splitPlot2(aggData.ts[,col],
                     switchObservation=32,
                     frequency = 12,
                     firstMonth = c(2011,9),
                     lastPreMonth = c(2014,4),
                     firstPostMonth = c(2014,5),
                     lastMonth=c(2017,12),
                     arOrder=3,
                     ylim=c(0,y_ul[init]),
                     ylab=paste0(y_lab[init]," ($)"),
                     main=paste0("Interrupted Time Series Model", "\n", y_lab[init]),
                     r=round
  )
  dev.off()
}

y <- c("tvdc_cpi_surg1")
y_ul <- c(50000)
y_lab <- c("Patient risk-adjusted total variable direct costs \nSurgical patients")
round = rep(3, length(y))

init <- 0
for (col in y) {
  init <-  init + 1
  pdf(paste("~/Dropbox/Research/VBM/results/its_",col,".pdf", sep=""))
  rr <- paste0("its_",col)

  print(col)
  rr <- f_splitPlot2(aggData.ts[,col],
                     switchObservation=32,
                     frequency = 12,
                     firstMonth = c(2011,9),
                     lastPreMonth = c(2014,4),
                     firstPostMonth = c(2014,5),
                     lastMonth=c(2017,12),
                     arOrder=1,
                     ylim=c(0,y_ul[init]),
                     ylab=paste0("Patient risk-adjusted total variable direct costs"," ($)"),
                     main=paste0("Interrupted Time Series Model", "\n", y_lab[init]),
                     r=round
  )
  dev.off()
}

y <- c("tvdc_cpi_surg0")
y_ul <- c(4000)
y_lab <- c("Patient risk-adjusted total variable direct costs \nMedical patients")
round = rep(3, length(y))

init <- 0
for (col in y) {
  init <-  init + 1
  pdf(paste("~/Dropbox/Research/VBM/results/its_",col,".pdf", sep=""))
  rr <- paste0("its_",col)

  print(col)
  rr <- f_splitPlot2(aggData.ts[,col],
                     switchObservation=32,
                     frequency = 12,
                     firstMonth = c(2011,9),
                     lastPreMonth = c(2014,4),
                     firstPostMonth = c(2014,5),
                     lastMonth=c(2017,12),
                     arOrder=3,
                     ylim=c(0,y_ul[init]),
                     ylab=paste0("Patient risk-adjusted total variable direct costs"," ($)"),
                     main=paste0("Interrupted Time Series Model", "\n", y_lab[init]),
                     r=round
  )
  dev.off()
}
```


Run ITS model with marginal effects from the patient-level analysis - using % change from the pre-intervention mean 
```{r}
# PACF order= 3 for all & medical pats; =1 for med pats

y <- c("pch")
y_ul <- c(15)
y_lab <- c("% Change in patient risk-adjusted costs from pre-VBM mean\nAll patients")
round = rep(3, length(y))

init <- 0
for (col in y) {
  init <-  init + 1
  pdf(paste("~/Dropbox/Research/VBM/results/its_",col,".pdf", sep=""))
  rr <- paste0("its_",col)

  print(col)
  rr <- f_splitPlot2(aggData.ts[,col],
                     switchObservation=32,
                     frequency = 12,
                     firstMonth = c(2011,9),
                     lastPreMonth = c(2014,4),
                     firstPostMonth = c(2014,5),
                     lastMonth=c(2017,12),
                     arOrder=3,
                     ylim=c(-1*y_ul[init],y_ul[init]),
                     ylab="Percentage change (%)",
                     main=paste0("Interrupted Time Series Model", "\n", y_lab[init]),
                     r=round
  )
  dev.off()
}

y <- c("pch_surg1")
y_ul <- c(15)
y_lab <- c("% Change in patient risk-adjusted costs from pre-VBM mean\nSurgical patients")
round = rep(3, length(y))

init <- 0
for (col in y) {
  init <-  init + 1
  pdf(paste("~/Dropbox/Research/VBM/results/its_",col,".pdf", sep=""))
  rr <- paste0("its_",col)

  print(col)
  rr <- f_splitPlot2(aggData.ts[,col],
                     switchObservation=32,
                     frequency = 12,
                     firstMonth = c(2011,9),
                     lastPreMonth = c(2014,4),
                     firstPostMonth = c(2014,5),
                     lastMonth=c(2017,12),
                     arOrder=1,
                     ylim=c(-1*y_ul[init],y_ul[init]),
                     ylab="Percentage change (%)",
                     main=paste0("Interrupted Time Series Model", "\n", y_lab[init]),
                     r=round
  )
  dev.off()
}

y <- c("pch_surg0")
y_ul <- c(15)
y_lab <- c("% Change in patient risk-adjusted costs from pre-VBM mean\nMedical patients")
round = rep(3, length(y))

init <- 0
for (col in y) {
  init <-  init + 1
  pdf(paste("~/Dropbox/Research/VBM/results/its_",col,".pdf", sep=""))
  rr <- paste0("its_",col)

  print(col)
  rr <- f_splitPlot2(aggData.ts[,col],
                     switchObservation=32,
                     frequency = 12,
                     firstMonth = c(2011,9),
                     lastPreMonth = c(2014,4),
                     firstPostMonth = c(2014,5),
                     lastMonth=c(2017,12),
                     arOrder=3,
                     ylim=c(-1*y_ul[init],y_ul[init]),
                     ylab="Percentage change (%)",
                     main=paste0("Interrupted Time Series Model", "\n", y_lab[init]),
                     r=round
  )
  dev.off()
}
```

# SPC of risk-adjsuted total costs (estimated from running the patient-level analysis) - used for paper
```{r}
library(qcc)
# to implement own version: http://blog.yhat.com/posts/quality-control-in-r.html

racost2 <- subset(racost, (DischargeDateMonth < "201209" | DischargeDateMonth > "201308"))

names(racost2$DischargeDateMonth) <- racost2$DischargeDateMonth

# normalize the cost by substracting the mean cost and dividing by the SD of the cost during the pre-period (2011/09 - 2012/04) 
monthly_cost <- ddply(racost2, .(int), summarise, tvdc_cpiM=mean(tvdc_cpi, na.rm=TRUE), tvdc_cpi_surg0M=mean(tvdc_cpi_surg0, na.rm=TRUE), tvdc_cpi_surg1M=mean(tvdc_cpi_surg1, na.rm=TRUE))
# mean cost in pre
# all patients = 2809.575
# med = 2626.095
# surg = 34150.72

# plot % change for all patients
racost2$tvdc_cpi <-  100*(racost2$tvdc_cpi - 2809.575)/2809.575
racost2$tvdc_cpi_surg0 <-  100*(racost2$tvdc_cpi_surg0 - 2626.095)/2626.095
racost2$tvdc_cpi_surg1 <-  100*(racost2$tvdc_cpi_surg1 - 34150.72)/34150.72

names(racost2$DischargeDateMonth) <- racost2$DischargeDateMonth

# mark dots in yellow = run of at least 8 consecutive observations above/below the mean
old <- qcc.options()
qcc.options("run.length"=8)

# all patients
png("~/Dropbox/Research/VBM/results/qcc_racost.png")
my.xmr.x <- qcc(data =  qcc.groups(racost2$tvdc_cpi[racost2$int==0],
                                   racost2$DischargeDateMonth[racost2$int==0]),
                 newdata= qcc.groups(racost2$tvdc_cpi[racost2$int==1],
                                     racost2$DischargeDateMonth[racost2$int==1]),
                title="All patients",
                type = "xbar.one",
                ylim=c(-15,15),
                ylab="% change (%) in direct variable costs per discharge*",
                xlab="",
                axes.las = 1,
                add.stats = F,
                label.limits = c("","")) 
dev.off()

# surgical
png("~/Dropbox/Research/VBM/results/qcc_racost_surg1.png")
my.xmr.x <- qcc(data =  qcc.groups(racost2$tvdc_cpi_surg1[racost2$int==0],
                                   racost2$DischargeDateMonth[racost2$int==0]),
                 newdata= qcc.groups(racost2$tvdc_cpi_surg1[racost2$int==1],
                                     racost2$DischargeDateMonth[racost2$int==1]),
                title="Surgical DRGs",
                type = "xbar.one",
                ylim=c(-15,15),
                ylab="% change (%) in direct variable costs per discharge*",
                xlab="",
                axes.las = 1,
                add.stats = F,
                label.limits = c("","")
                )
dev.off()

# medical
png("~/Dropbox/Research/VBM/results/qcc_racost_surg0.png")
my.xmr.x <- qcc(data =  qcc.groups(racost2$tvdc_cpi_surg0[racost2$int==0],
                                   racost2$DischargeDateMonth[racost2$int==0]),
                 newdata= qcc.groups(racost2$tvdc_cpi_surg0[racost2$int==1],
                                     racost2$DischargeDateMonth[racost2$int==1]),
                title="Medical DRGs",
                type = "xbar.one",
                ylim=c(-15,15),
                ylab="% change (%) in direct variable costs per discharge*",
                xlab="",
                axes.las = 1,
                add.stats = F,
                label.limits = c("","")
                )
dev.off()
```
